<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WhisperBox â€” Sign up</title>
  <style>
    :root{--brand:#2b6ef6;--muted:#6b7280;--bg:#f7f9fc}
    html,body{height:100%;margin:0;font-family:Inter,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:#0f172a}
    .wrap{max-width:680px;margin:40px auto;padding:20px}
    .card{background:white;padding:28px;border-radius:12px;box-shadow:0 6px 30px rgba(16,24,40,0.06)}
    .logo{display:flex;align-items:center;gap:12px}
    .lock{width:48px;height:48px;background:var(--brand);border-radius:10px;display:inline-grid;place-items:center;color:white}
    h1{margin:8px 0 14px}
    form{max-width:520px}
    label{display:block;font-size:13px;margin-bottom:6px;color:var(--muted)}
    .field{margin-bottom:12px}
    input{width:100%;padding:12px;border:1px solid #e6eef8;border-radius:8px}
    .inline{display:flex;gap:12px}
    .small{font-size:13px;color:var(--muted)}
    .meter{height:8px;border-radius:8px;background:#e6eef8;overflow:hidden}
    .meter > i{display:block;height:100%;width:0;background:linear-gradient(90deg,#f97316,#16a34a)}
    .btn{background:var(--brand);color:white;padding:10px 14px;border-radius:8px;border:0;cursor:pointer}
    .error{color:#b91c1c;margin-top:8px}
    @media (max-width:520px){.inline{flex-direction:column}}
  </style>
  <!-- Firebase SDKs allowed -->
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="logo">
        <div class="lock" aria-hidden="true">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M6 10V8a6 6 0 1112 0v2" stroke="white" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/><rect x="4" y="10" width="16" height="10" rx="2" stroke="white" stroke-width="1.4"/></svg>
        </div>
        <div>
          <div style="font-weight:700;font-size:18px">WhisperBox</div>
          <div class="small">Safe. Anonymous. Expressive.</div>
        </div>
      </div>
      <h1>Create an account</h1>
      <p class="small">Accounts are required for moderation and some features. Your posts remain anonymous by default.</p>
      <form id="signup-form" novalidate>
        <div class="field">
          <label for="email">Email</label>
          <input id="email" name="email" type="email" autocomplete="email" required />
        </div>
        <div class="field">
          <label for="password">Password</label>
          <input id="password" name="password" type="password" autocomplete="new-password" required />
        </div>
        <div class="field">
          <label for="confirm">Confirm password</label>
          <input id="confirm" name="confirm" type="password" autocomplete="new-password" required />
        </div>
        <div class="field">
          <label for="strength">Password strength</label>
          <div class="meter" aria-hidden="true"><i id="meterBar"></i></div>
        </div>
        <div style="margin-top:12px;display:flex;gap:8px;align-items:center;">
          <button id="signupBtn" class="btn" type="submit">Create account</button>
          <button id="googleBtn" type="button" class="btn" style="background:#fff;color:var(--brand);border:1px solid #e6eef8">Sign up with Google</button>
        </div>
        <p class="error" id="errorMsg" role="status" aria-live="polite"></p>
        <p class="small" style="margin-top:12px">Already have an account? <a href="login.html">Sign in</a></p>
      </form>
    </div>
  </div>

  <script src="firebase-config.js"></script>
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js';
    import { getAuth, createUserWithEmailAndPassword, GoogleAuthProvider, signInWithPopup, sendEmailVerification, setPersistence, browserLocalPersistence, browserSessionPersistence } from 'https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js';
    import { getFirestore, doc, setDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "REPLACE_WITH_PROD_APIKEY",
      authDomain: "REPLACE_WITH_PROD_AUTHDOMAIN",
      projectId: "REPLACE_WITH_PROD_PROJECTID",
      storageBucket: "REPLACE_WITH_PROD_BUCKET",
      messagingSenderId: "REPLACE_WITH_PROD_SENDERID",
      appId: "REPLACE_WITH_PROD_APPID"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const emailInput = document.getElementById('email');
    const passwordInput = document.getElementById('password');
    const confirmInput = document.getElementById('confirm');
    const signupForm = document.getElementById('signup-form');
    const errorMsg = document.getElementById('errorMsg');
    const meterBar = document.getElementById('meterBar');

    function scorePassword(p){
      let score=0; if(p.length>=6) score+=1; if(/[A-Z]/.test(p)) score+=1; if(/[0-9]/.test(p)) score+=1; if(/[^A-Za-z0-9]/.test(p)) score+=1; return score;
    }

    passwordInput.addEventListener('input', ()=>{
      const s = scorePassword(passwordInput.value);
      const percent = (s/4)*100;
      meterBar.style.width = percent + '%';
      if(s<=1) meterBar.style.background = '#fb7185'; else if(s==2) meterBar.style.background = '#f59e0b'; else meterBar.style.background = '#16a34a';
    });

    function isValidEmail(v){return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v)}

    signupForm.addEventListener('submit', async (e)=>{
      e.preventDefault(); errorMsg.textContent='';
      const email = emailInput.value.trim(); const pw = passwordInput.value; const conf = confirmInput.value;
      if(!email || !pw || !conf){ errorMsg.textContent='All fields are required'; return; }
      if(!isValidEmail(email)){ errorMsg.textContent='Enter a valid email address'; return; }
      if(pw.length<6){ errorMsg.textContent='Password must be at least 6 characters'; return; }
      if(pw !== conf){ errorMsg.textContent='Passwords do not match'; return; }

      try{
        // Default to session persistence; frontend should connect Remember Me to local persistence if desired.
        await setPersistence(auth, browserSessionPersistence);
        const userCred = await createUserWithEmailAndPassword(auth, email, pw);
        const user = userCred.user;
        // Create anonymized user document: avoid storing email to preserve anonymity-first design.
        // Store only minimal account metadata that cannot be used to link posts. Customize schema server-side as needed.
        const userDoc = {
          uid: user.uid,
          createdAt: serverTimestamp(),
          anonymousHandle: `user-${user.uid.slice(0,6)}`,
          emailVerified: user.emailVerified || false
        };
        await setDoc(doc(db, 'users', user.uid), userDoc);
        await sendEmailVerification(user);
        // Sign out to enforce verification step before full login (UX choice)
        // NOTE: you can instead keep the user signed in but restrict actions until emailVerified === true.
        errorMsg.style.color = 'green';
        errorMsg.textContent = 'Account created. Verification email sent. Please check your inbox.';
      }catch(err){
        console.error(err);
        const code = err.code || err.message || '';
        if(code.includes('already')||code.includes('email-already-in-use')) errorMsg.textContent='An account with that email already exists.';
        else if(code.includes('network')) errorMsg.textContent='Network error. Please try again.';
        else errorMsg.textContent='Could not create account. Please try again.';
      }
    });

    // Google signup (similar to login flow)
    document.getElementById('googleBtn').addEventListener('click', async ()=>{
      try{
        const provider = new GoogleAuthProvider();
        const res = await signInWithPopup(auth, provider);
        const user = res.user;
        // Create minimal anonymized doc if new
        await setDoc(doc(db, 'users', user.uid), {
          uid: user.uid,
          createdAt: serverTimestamp(),
          anonymousHandle: `user-${user.uid.slice(0,6)}`,
          emailVerified: user.emailVerified || false
        }, { merge: true });
        if(!user.emailVerified){ await sendEmailVerification(user); }
        errorMsg.style.color='green'; errorMsg.textContent='Signed up with Google. Redirecting...';
        window.location.href = '/index.html';
      }catch(err){ console.error(err); errorMsg.textContent='Google sign-up failed.'; }
    });
  </script>
</body>
</html>
